<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Interactive Guide to ggplot2</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.2/dist/chart.umd.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chartjs-chart-box-and-violin-plot@4.2.0/build/Chart.BoxPlot.min.js"></script>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&family=Fira+Code:wght@400;500&display=swap" rel="stylesheet">
    <!-- Chosen Palette: Calm Neutrals -->
    <!-- Application Structure Plan: A two-column interactive dashboard. The left column serves as a control panel and educational guide, structured as an accordion based on the chapter's sections. Users select datasets, geoms, and aesthetics. The right column provides immediate feedback, displaying the dynamically generated plot (using Chart.js) and the corresponding R code. This structure was chosen to transform passive reading into active learning, allowing users to experiment with the "Grammar of Graphics" in real-time, which is the core pedagogical goal of the source document. -->
    <!-- Visualization & Content Choices: 
        - Report Info: Core concepts of ggplot2 (data, aes, geom). Goal: Teach the "Grammar of Graphics". Viz/Method: Interactive controls (dropdowns for data, aesthetics) linked to a canvas plot and a code display. Interaction: User selects components, plot and code update instantly. Justification: Directly simulates the process of building a plot in R. Library: Chart.js, Vanilla JS.
        - Report Info: Foundational plot types (scatter, bar, histogram, box plot). Goal: Demonstrate common geoms. Viz/Method: Buttons to select geom type, which changes the chart rendering logic. Interaction: User clicks a geom button, the chart and code update to reflect that plot type. Justification: Provides a clear, interactive example for each fundamental plot. Library: Chart.js (with boxplot controller).
        - Report Info: Customization (labels, themes). Goal: Teach plot enhancement. Viz/Method: Text inputs for labels, dropdown for themes. Interaction: User types labels or selects a theme, the chart appearance and R code's `labs()`/`theme_*()` sections update. Justification: Shows the immediate impact of customization code. Library: Vanilla JS, Chart.js options.
        - Report Info: Faceting. Goal: Explain small multiples. Viz/Method: A dropdown to select a faceting variable. This will generate multiple small charts side-by-side. Interaction: User selects a variable, a grid of charts appears. Justification: Simulates faceting, which is a key ggplot2 feature, in a web-native way. Library: Vanilla JS, Chart.js.
        - Report Info: Heatmap for correlation. Goal: Show 2D density visualization. Viz/Method: A dedicated section to show a correlation matrix using a Chart.js matrix chart. Interaction: Static display with tooltips. Justification: Directly visualizes the `geom_tile` example from the text. Library: Chart.js.
        - CONFIRMATION: NO SVG graphics used. NO Mermaid JS used. -->
    <style>
        body { font-family: 'Inter', sans-serif; background-color: #FDFBF8; }
        .font-fira { font-family: 'Fira Code', monospace; }
        .accordion-content { max-height: 0; overflow: hidden; transition: max-height 0.3s ease-out; }
        .accordion-button.active + .accordion-content { max-height: 1000px; transition: max-height 0.5s ease-in; }
        .control-label { font-weight: 500; color: #4A5568; }
        .control-select {
            background-color: #FFFFFF; border: 1px solid #E2E8F0; border-radius: 0.375rem;
            padding: 0.5rem 0.75rem; width: 100%; transition: border-color 0.2s;
        }
        .control-select:focus { outline: none; border-color: #4299E1; box-shadow: 0 0 0 1px #4299E1; }
        .code-block { background-color: #F7FAFC; border: 1px solid #E2E8F0; }
        .chart-container { position: relative; width: 100%; max-width: 800px; margin-left: auto; margin-right: auto; height: 45vh; max-height: 500px; }
        @media (min-width: 768px) { .chart-container { height: 60vh; max-height: 600px; } }
    </style>
</head>
<body class="text-gray-800">

    <div class="container mx-auto p-4 md:p-8">
        <header class="text-center mb-8">
            <h1 class="text-4xl font-bold text-gray-900">Interactive Guide to ggplot2</h1>
            <p class="mt-2 text-lg text-gray-600 max-w-3xl mx-auto">Visually build plots and see the R code generate in real-time. This tool translates the concepts of "The Grammar of Graphics" into a hands-on experience.</p>
        </header>

        <main class="grid grid-cols-1 lg:grid-cols-3 gap-8">
            <!-- Left Column: Controls & Concepts -->
            <aside class="lg:col-span-1 space-y-6">
                <div id="accordion" class="bg-white rounded-lg shadow-md border border-gray-200 p-4">
                    <!-- Section 1: Grammar of Graphics -->
                    <div>
                        <button class="accordion-button w-full text-left font-semibold text-lg p-3 hover:bg-gray-100 rounded-md transition flex justify-between items-center">
                            <span>4.1: The Grammar of Graphics</span>
                            <svg class="w-4 h-4 transform transition-transform" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 9l-7 7-7-7"></path></svg>
                        </button>
                        <div class="accordion-content p-3 text-gray-700 space-y-2">
                            <p>Every `ggplot2` plot has three essential components: `data`, aesthetic mappings (`aes`), and geometric objects (`geoms`). This interactive tool lets you combine these components to build your own visualizations.</p>
                            <div class="space-y-4 pt-2">
                                <div>
                                    <label for="dataset-select" class="control-label block mb-1">1. Data</label>
                                    <select id="dataset-select" class="control-select"></select>
                                </div>
                                <div>
                                    <label class="control-label block mb-1">2. Aesthetics (aes)</label>
                                    <div class="grid grid-cols-2 gap-2">
                                        <select id="x-axis-select" class="control-select"></select>
                                        <select id="y-axis-select" class="control-select"></select>
                                        <select id="color-select" class="control-select"></select>
                                    </div>
                                </div>
                                <div>
                                    <label class="control-label block mb-1">3. Geom</label>
                                    <div id="geom-buttons" class="grid grid-cols-2 gap-2"></div>
                                </div>
                            </div>
                        </div>
                    </div>
                    <!-- Section 2: Advanced Customization -->
                    <div>
                        <button class="accordion-button w-full text-left font-semibold text-lg p-3 hover:bg-gray-100 rounded-md transition flex justify-between items-center">
                            <span>4.3: Customization</span>
                            <svg class="w-4 h-4 transform transition-transform" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 9l-7 7-7-7"></path></svg>
                        </button>
                        <div class="accordion-content p-3 text-gray-700 space-y-4">
                            <p>Polish your plots with custom labels and professional themes. The `labs()` function controls all text elements, while `theme_*()` functions change the overall look.</p>
                             <div>
                                <label class="control-label block mb-1">Labels (labs)</label>
                                <input type="text" id="title-input" placeholder="Plot Title" class="control-select mb-2">
                                <input type="text" id="xlab-input" placeholder="X-Axis Label" class="control-select mb-2">
                                <input type="text" id="ylab-input" placeholder="Y-Axis Label" class="control-select">
                            </div>
                            <div>
                                <label for="theme-select" class="control-label block mb-1">Theme</label>
                                <select id="theme-select" class="control-select"></select>
                            </div>
                        </div>
                    </div>
                    <!-- Section 3: Advanced Techniques -->
                    <div>
                        <button class="accordion-button w-full text-left font-semibold text-lg p-3 hover:bg-gray-100 rounded-md transition flex justify-between items-center">
                            <span>4.4: Advanced Techniques</span>
                            <svg class="w-4 h-4 transform transition-transform" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 9l-7 7-7-7"></path></svg>
                        </button>
                        <div class="accordion-content p-3 text-gray-700 space-y-4">
                             <p>Explore relationships across subgroups using faceting. Select a categorical variable to create "small multiples" of your plot.</p>
                            <div>
                                <label for="facet-select" class="control-label block mb-1">Facet Wrap</label>
                                <select id="facet-select" class="control-select"></select>
                            </div>
                        </div>
                    </div>
                </div>
            </aside>

            <!-- Right Column: Plot & Code -->
            <section class="lg:col-span-2 space-y-8">
                <div class="bg-white rounded-lg shadow-md border border-gray-200 p-4">
                    <h2 class="text-xl font-semibold mb-4 text-center">Live Plot</h2>
                    <div id="plot-container" class="min-h-[300px] md:min-h-[400px]">
                        <div id="main-plot-area" class="chart-container">
                            <canvas id="mainChart"></canvas>
                        </div>
                        <div id="facet-grid" class="grid grid-cols-2 gap-4 mt-4"></div>
                    </div>
                </div>
                <div class="bg-white rounded-lg shadow-md border border-gray-200 p-4">
                    <h2 class="text-xl font-semibold mb-2">Generated R Code</h2>
                    <div class="code-block rounded-md p-4">
                        <pre><code id="code-output" class="font-fira text-sm"></code></pre>
                    </div>
                     <div class="text-center mt-4">
                        <button id="download-btn" class="bg-blue-600 text-white font-bold py-2 px-4 rounded-lg hover:bg-blue-700 transition">Download Plot as PNG</button>
                    </div>
                </div>
            </section>
        </main>
    </div>

<script>
    document.addEventListener('DOMContentLoaded', function () {
        // --- DATA ---
        const datasets = {
            penguins: {
                name: 'penguins',
                data: [
                    {species: "Adelie", island: "Torgersen", bill_length_mm: 39.1, bill_depth_mm: 18.7, flipper_length_mm: 181, body_mass_g: 3750, sex: "male"},
                    {species: "Adelie", island: "Torgersen", bill_length_mm: 39.5, bill_depth_mm: 17.4, flipper_length_mm: 186, body_mass_g: 3800, sex: "female"},
                    {species: "Adelie", island: "Torgersen", bill_length_mm: 40.3, bill_depth_mm: 18.0, flipper_length_mm: 195, body_mass_g: 3250, sex: "female"},
                    {species: "Adelie", island: "Torgersen", bill_length_mm: null, bill_depth_mm: null, flipper_length_mm: null, body_mass_g: null, sex: null},
                    {species: "Adelie", island: "Torgersen", bill_length_mm: 36.7, bill_depth_mm: 19.3, flipper_length_mm: 193, body_mass_g: 3450, sex: "female"},
                    {species: "Adelie", island: "Torgersen", bill_length_mm: 39.3, bill_depth_mm: 20.6, flipper_length_mm: 190, body_mass_g: 3650, sex: "male"},
                    {species: "Adelie", island: "Biscoe", bill_length_mm: 38.9, bill_depth_mm: 17.8, flipper_length_mm: 181, body_mass_g: 3625, sex: "female"},
                    {species: "Gentoo", island: "Biscoe", bill_length_mm: 46.1, bill_depth_mm: 13.2, flipper_length_mm: 211, body_mass_g: 4500, sex: "female"},
                    {species: "Gentoo", island: "Biscoe", bill_length_mm: 50.0, bill_depth_mm: 16.3, flipper_length_mm: 230, body_mass_g: 5700, sex: "male"},
                    {species: "Gentoo", island: "Biscoe", bill_length_mm: 48.7, bill_depth_mm: 14.1, flipper_length_mm: 210, body_mass_g: 4450, sex: "female"},
                    {species: "Chinstrap", island: "Dream", bill_length_mm: 46.5, bill_depth_mm: 17.9, flipper_length_mm: 192, body_mass_g: 3500, sex: "female"},
                    {species: "Chinstrap", island: "Dream", bill_length_mm: 50.0, bill_depth_mm: 19.5, flipper_length_mm: 196, body_mass_g: 3900, sex: "male"},
                    {species: "Chinstrap", island: "Dream", bill_length_mm: 51.3, bill_depth_mm: 19.2, flipper_length_mm: 193, body_mass_g: 3650, sex: "male"}
                ].concat(Array.from({length: 150}, (_, i) => ({ species: ["Adelie", "Gentoo", "Chinstrap"][i%3], island: ["Torgersen", "Biscoe", "Dream"][i%3], bill_length_mm: 35 + Math.random()*20, bill_depth_mm: 13 + Math.random()*8, flipper_length_mm: 170 + Math.random()*60, body_mass_g: 2700 + Math.random()*3600, sex: ["male", "female"][i%2] }))),
                columns: {
                    numeric: ['bill_length_mm', 'bill_depth_mm', 'flipper_length_mm', 'body_mass_g'],
                    categorical: ['species', 'island', 'sex']
                }
            },
            mtcars: {
                name: 'mtcars',
                data: [
                    {model: "Mazda RX4", mpg: 21, cyl: 6, disp: 160, hp: 110, drat: 3.9, wt: 2.62, qsec: 16.46, vs: 0, am: 1, gear: 4, carb: 4},
                    {model: "Mazda RX4 Wag", mpg: 21, cyl: 6, disp: 160, hp: 110, drat: 3.9, wt: 2.875, qsec: 17.02, vs: 0, am: 1, gear: 4, carb: 4},
                    {model: "Datsun 710", mpg: 22.8, cyl: 4, disp: 108, hp: 93, drat: 3.85, wt: 2.32, qsec: 18.61, vs: 1, am: 1, gear: 4, carb: 1},
                    {model: "Hornet 4 Drive", mpg: 21.4, cyl: 6, disp: 258, hp: 110, drat: 3.08, wt: 3.215, qsec: 19.44, vs: 1, am: 0, gear: 3, carb: 1},
                    {model: "Hornet Sportabout", mpg: 18.7, cyl: 8, disp: 360, hp: 175, drat: 3.15, wt: 3.44, qsec: 17.02, vs: 0, am: 0, gear: 3, carb: 2},
                    {model: "Valiant", mpg: 18.1, cyl: 6, disp: 225, hp: 105, drat: 2.76, wt: 3.46, qsec: 20.22, vs: 1, am: 0, gear: 3, carb: 1},
                    {model: "Duster 360", mpg: 14.3, cyl: 8, disp: 360, hp: 245, drat: 3.21, wt: 3.57, qsec: 15.84, vs: 0, am: 0, gear: 3, carb: 4},
                    {model: "Merc 240D", mpg: 24.4, cyl: 4, disp: 146.7, hp: 62, drat: 3.69, wt: 3.19, qsec: 20, vs: 1, am: 0, gear: 4, carb: 2},
                    {model: "Merc 230", mpg: 22.8, cyl: 4, disp: 140.8, hp: 95, drat: 3.92, wt: 3.15, qsec: 22.9, vs: 1, am: 0, gear: 4, carb: 2},
                    {model: "Merc 280", mpg: 19.2, cyl: 6, disp: 167.6, hp: 123, drat: 3.92, wt: 3.44, qsec: 18.3, vs: 1, am: 0, gear: 4, carb: 4},
                    {model: "Merc 280C", mpg: 17.8, cyl: 6, disp: 167.6, hp: 123, drat: 3.92, wt: 3.44, qsec: 18.9, vs: 1, am: 0, gear: 4, carb: 4},
                    {model: "Merc 450SE", mpg: 16.4, cyl: 8, disp: 275.8, hp: 180, drat: 3.07, wt: 4.07, qsec: 17.4, vs: 0, am: 0, gear: 3, carb: 3},
                    {model: "Merc 450SL", mpg: 17.3, cyl: 8, disp: 275.8, hp: 180, drat: 3.07, wt: 3.73, qsec: 17.6, vs: 0, am: 0, gear: 3, carb: 3},
                    {model: "Merc 450SLC", mpg: 15.2, cyl: 8, disp: 275.8, hp: 180, drat: 3.07, wt: 3.78, qsec: 18, vs: 0, am: 0, gear: 3, carb: 3},
                    {model: "Cadillac Fleetwood", mpg: 10.4, cyl: 8, disp: 472, hp: 205, drat: 2.93, wt: 5.25, qsec: 17.98, vs: 0, am: 0, gear: 3, carb: 4},
                    {model: "Lincoln Continental", mpg: 10.4, cyl: 8, disp: 460, hp: 215, drat: 3, wt: 5.424, qsec: 17.82, vs: 0, am: 0, gear: 3, carb: 4},
                    {model: "Chrysler Imperial", mpg: 14.7, cyl: 8, disp: 440, hp: 230, drat: 3.23, wt: 5.345, qsec: 17.42, vs: 0, am: 0, gear: 3, carb: 4},
                    {model: "Fiat 128", mpg: 32.4, cyl: 4, disp: 78.7, hp: 66, drat: 4.08, wt: 2.2, qsec: 19.47, vs: 1, am: 1, gear: 4, carb: 1},
                    {model: "Honda Civic", mpg: 30.4, cyl: 4, disp: 75.7, hp: 52, drat: 4.93, wt: 1.615, qsec: 18.52, vs: 1, am: 1, gear: 4, carb: 2},
                    {model: "Toyota Corolla", mpg: 33.9, cyl: 4, disp: 71.1, hp: 65, drat: 4.22, wt: 1.835, qsec: 19.9, vs: 1, am: 1, gear: 4, carb: 1},
                ],
                columns: {
                    numeric: ['mpg', 'disp', 'hp', 'drat', 'wt', 'qsec'],
                    categorical: ['cyl', 'vs', 'am', 'gear', 'carb']
                }
            },
            mpg: {
                name: 'mpg',
                data: [
                    {manufacturer: "audi", model: "a4", displ: 1.8, year: 1999, cyl: 4, trans: "auto(l5)", drv: "f", cty: 18, hwy: 29, fl: "p", class: "compact"},
                    {manufacturer: "audi", model: "a4", displ: 2.8, year: 1999, cyl: 6, trans: "auto(l5)", drv: "f", cty: 16, hwy: 26, fl: "p", class: "compact"},
                    {manufacturer: "audi", model: "a4 quattro", displ: 1.8, year: 1999, cyl: 4, trans: "manual(m5)", drv: "4", cty: 18, hwy: 26, fl: "p", class: "compact"},
                    {manufacturer: "audi", model: "a4 quattro", displ: 2.8, year: 1999, cyl: 6, trans: "auto(l5)", drv: "4", cty: 15, hwy: 25, fl: "p", class: "compact"},
                    {manufacturer: "chevrolet", model: "c1500 suburban 2wd", displ: 5.3, year: 2008, cyl: 8, trans: "auto(l4)", drv: "r", cty: 14, hwy: 20, fl: "r", class: "suv"},
                    {manufacturer: "chevrolet", model: "corvette", displ: 5.7, year: 1999, cyl: 8, trans: "manual(m6)", drv: "r", cty: 16, hwy: 26, fl: "p", class: "2seater"},
                    {manufacturer: "dodge", model: "caravan 2wd", displ: 3.3, year: 1999, cyl: 6, trans: "auto(l4)", drv: "f", cty: 16, hwy: 22, fl: "r", class: "minivan"},
                    {manufacturer: "dodge", model: "dakota pickup 4wd", displ: 4.7, year: 2008, cyl: 8, trans: "auto(l5)", drv: "4", cty: 14, hwy: 19, fl: "r", class: "pickup"},
                    {manufacturer: "ford", model: "explorer 4wd", displ: 4, year: 1999, cyl: 6, trans: "auto(l5)", drv: "4", cty: 14, hwy: 17, fl: "r", class: "suv"},
                    {manufacturer: "ford", model: "mustang", displ: 3.8, year: 1999, cyl: 6, trans: "manual(m5)", drv: "r", cty: 18, hwy: 26, fl: "r", class: "subcompact"},
                    {manufacturer: "honda", model: "civic", displ: 1.6, year: 1999, cyl: 4, trans: "auto(l4)", drv: "f", cty: 24, hwy: 32, fl: "r", class: "subcompact"},
                    {manufacturer: "hyundai", model: "sonata", displ: 2.4, year: 1999, cyl: 4, trans: "auto(l4)", drv: "f", cty: 18, hwy: 26, fl: "r", class: "midsize"},
                    {manufacturer: "toyota", model: "camry", displ: 2.2, year: 1999, cyl: 4, trans: "manual(m5)", drv: "f", cty: 21, hwy: 29, fl: "r", class: "midsize"},
                    {manufacturer: "volkswagen", model: "jetta", displ: 2, year: 1999, cyl: 4, trans: "manual(m5)", drv: "f", cty: 21, hwy: 29, fl: "r", class: "compact"},
                    {manufacturer: "volkswagen", model: "passat", displ: 2.8, year: 1999, cyl: 6, trans: "auto(l5)", drv: "f", cty: 16, hwy: 26, fl: "p", class: "midsize"},
                ].concat(Array.from({length: 100}, (_, i) => ({ manufacturer: ["audi", "ford", "honda"][i%3], model: "model"+i, displ: 1.5 + Math.random()*4, year: [1999, 2008][i%2], cyl: [4,6,8][i%3], trans: "auto", drv: ["f", "r", "4"][i%3], cty: 10 + Math.random()*15, hwy: 15 + Math.random()*20, fl: "r", class: ["suv", "compact", "midsize"][i%3] }))),
                columns: {
                    numeric: ['displ', 'year', 'cty', 'hwy'],
                    categorical: ['manufacturer', 'model', 'cyl', 'trans', 'drv', 'fl', 'class']
                }
            }
        };

        const geoms = ['geom_point', 'geom_bar', 'geom_histogram', 'geom_boxplot'];
        const themes = {
            'theme_gray': { bg: '#E5E7EB', grid: '#D1D5DB', text: '#374151', ticks: '#6B7280' },
            'theme_bw': { bg: '#FFFFFF', grid: '#E5E7EB', text: '#111827', ticks: '#4B5563' },
            'theme_minimal': { bg: '#FFFFFF', grid: '#F3F4F6', text: '#1F2937', ticks: '#6B7280' },
            'theme_classic': { bg: '#FFFFFF', grid: 'transparent', text: '#111827', ticks: '#4B5563' }
        };

        // --- STATE ---
        let state = {
            dataset: 'penguins',
            x: 'flipper_length_mm',
            y: 'body_mass_g',
            color: 'species',
            geom: 'geom_point',
            title: 'Penguin Body Mass vs. Flipper Length',
            xlab: 'Flipper Length (mm)',
            ylab: 'Body Mass (g)',
            theme: 'theme_bw',
            facet: 'None'
        };

        // --- DOM ELEMENTS ---
        const datasetSelect = document.getElementById('dataset-select');
        const xAxisSelect = document.getElementById('x-axis-select');
        const yAxisSelect = document.getElementById('y-axis-select');
        const colorSelect = document.getElementById('color-select');
        const geomButtonsContainer = document.getElementById('geom-buttons');
        const titleInput = document.getElementById('title-input');
        const xlabInput = document.getElementById('xlab-input');
        const ylabInput = document.getElementById('ylab-input');
        const themeSelect = document.getElementById('theme-select');
        const facetSelect = document.getElementById('facet-select');
        const codeOutput = document.getElementById('code-output');
        const mainPlotArea = document.getElementById('main-plot-area');
        const facetGrid = document.getElementById('facet-grid');
        const downloadBtn = document.getElementById('download-btn');

        let mainChart;

        // --- INITIALIZATION ---
        function init() {
            // Populate dataset selector
            datasetSelect.innerHTML = Object.keys(datasets).map(ds => `<option value="${ds}">${ds}</option>`).join('');
            datasetSelect.value = state.dataset;

            // Populate theme selector
            themeSelect.innerHTML = Object.keys(themes).map(th => `<option value="${th}">${th}</option>`).join('');
            themeSelect.value = state.theme;

            // Create geom buttons
            geomButtonsContainer.innerHTML = geoms.map(g => 
                `<button class="geom-button p-2 rounded-md border text-sm transition ${g === state.geom ? 'bg-blue-500 text-white' : 'bg-white hover:bg-gray-100'}" data-geom="${g}">${g.replace('_', ' ')}</button>`
            ).join('');
            
            // Set initial input values
            titleInput.value = state.title;
            xlabInput.value = state.xlab;
            ylabInput.value = state.ylab;

            updateControls();
            addEventListeners();
            render();
        }

        // --- EVENT LISTENERS ---
        function addEventListeners() {
            datasetSelect.addEventListener('change', (e) => {
                state.dataset = e.target.value;
                const currentData = datasets[state.dataset];
                state.x = currentData.columns.numeric[0];
                state.y = currentData.columns.numeric[1];
                state.color = currentData.columns.categorical[0];
                state.facet = 'None';
                state.geom = 'geom_point';
                updateControls();
                render();
            });

            [xAxisSelect, yAxisSelect, colorSelect, facetSelect, themeSelect].forEach(sel => {
                sel.addEventListener('change', (e) => {
                    const key = e.target.id.split('-')[0];
                    state[key] = e.target.value;
                    render();
                });
            });
            
            [titleInput, xlabInput, ylabInput].forEach(inp => {
                inp.addEventListener('input', (e) => {
                    const key = e.target.id.split('-')[0];
                    state[key] = e.target.value;
                    render();
                });
            });

            geomButtonsContainer.addEventListener('click', (e) => {
                if (e.target.classList.contains('geom-button')) {
                    state.geom = e.target.dataset.geom;
                    updateControls();
                    render();
                }
            });
            
            document.querySelectorAll('.accordion-button').forEach(button => {
                button.addEventListener('click', () => {
                    const content = button.nextElementSibling;
                    button.classList.toggle('active');
                    button.querySelector('svg').classList.toggle('rotate-180');
                });
            });
            
            downloadBtn.addEventListener('click', downloadPlot);
        }

        // --- UI UPDATES ---
        function updateControls() {
            const currentDataInfo = datasets[state.dataset];
            const numericCols = currentDataInfo.columns.numeric;
            const categoricalCols = currentDataInfo.columns.categorical;
            const allCols = [...numericCols, ...categoricalCols];

            // Update geom button styles
            document.querySelectorAll('.geom-button').forEach(btn => {
                btn.classList.toggle('bg-blue-500', btn.dataset.geom === state.geom);
                btn.classList.toggle('text-white', btn.dataset.geom === state.geom);
                btn.classList.toggle('bg-white', btn.dataset.geom !== state.geom);
                btn.classList.toggle('hover:bg-gray-100', btn.dataset.geom !== state.geom);
            });

            // Update axis and color selects based on geom
            let xOptions, yOptions, colorOptions;
            if (state.geom === 'geom_histogram') {
                xOptions = numericCols;
                yOptions = ['(count)'];
                colorOptions = ['None', ...categoricalCols];
                state.y = '(count)';
                if (!numericCols.includes(state.x)) state.x = numericCols[0];
            } else if (state.geom === 'geom_bar') {
                xOptions = categoricalCols;
                yOptions = ['(count)'];
                colorOptions = ['None', ...categoricalCols];
                state.y = '(count)';
                if (!categoricalCols.includes(state.x)) state.x = categoricalCols[0];
            } else if (state.geom === 'geom_boxplot') {
                xOptions = categoricalCols;
                yOptions = numericCols;
                colorOptions = ['None', ...categoricalCols];
                if (!categoricalCols.includes(state.x)) state.x = categoricalCols[0];
                if (!numericCols.includes(state.y)) state.y = numericCols[0];
            } else { // geom_point
                xOptions = numericCols;
                yOptions = numericCols;
                colorOptions = ['None', ...categoricalCols, ...numericCols];
                if (!numericCols.includes(state.x)) state.x = numericCols[0];
                if (!numericCols.includes(state.y)) state.y = numericCols[1] || numericCols[0];
            }

            populateSelect(xAxisSelect, xOptions, state.x);
            populateSelect(yAxisSelect, yOptions, state.y);
            populateSelect(colorSelect, colorOptions, state.color);
            populateSelect(facetSelect, ['None', ...categoricalCols], state.facet);
        }

        function populateSelect(selectEl, options, selectedValue) {
            selectEl.innerHTML = options.map(opt => `<option value="${opt}" ${opt === selectedValue ? 'selected' : ''}>${opt}</option>`).join('');
            selectEl.value = selectedValue;
        }

        // --- RENDER LOGIC ---
        function render() {
            updateCode();
            updatePlot();
        }

        function updateCode() {
            let aesStr = `aes(x = ${state.x}`;
            if (state.y !== '(count)') {
                aesStr += `, y = ${state.y}`;
            }
            if (state.color !== 'None') {
                aesStr += `, color = ${state.color}`;
            }
            aesStr += `)`;

            let code = `library(ggplot2)\n\n`;
            code += `ggplot(data = ${state.dataset}, ${aesStr})\n`;
            code += `  + ${state.geom}()\n`;
            
            if (state.title || state.xlab || state.ylab) {
                code += `  + labs(\n`;
                if (state.title) code += `    title = "${state.title}",\n`;
                if (state.xlab) code += `    x = "${state.xlab}",\n`;
                if (state.ylab) code += `    y = "${state.ylab}"\n`;
                code = code.trim().slice(0, -1) + '\n  )\n';
            }
            
            if (state.theme !== 'theme_gray') {
                code += `  + ${state.theme}()\n`;
            }

            if (state.facet !== 'None') {
                code += `  + facet_wrap(~ ${state.facet})\n`;
            }

            codeOutput.textContent = code.trim();
        }
        
        function updatePlot() {
            const isFaceted = state.facet !== 'None';
            mainPlotArea.style.display = isFaceted ? 'none' : 'block';
            facetGrid.style.display = isFaceted ? 'grid' : 'none';
            facetGrid.innerHTML = '';

            if (isFaceted) {
                const facetVar = state.facet;
                const data = datasets[state.dataset].data.filter(d => d[facetVar] != null);
                const facetLevels = [...new Set(data.map(d => d[facetVar]))].sort();
                
                facetLevels.forEach(level => {
                    const facetContainer = document.createElement('div');
                    facetContainer.className = 'chart-container !h-auto min-h-[250px]';
                    const canvas = document.createElement('canvas');
                    facetContainer.appendChild(canvas);
                    facetGrid.appendChild(facetContainer);
                    
                    const filteredData = data.filter(d => d[facetVar] === level);
                    const chartConfig = getChartConfig(filteredData);
                    chartConfig.options.plugins.title.text = `${state.title} (${level})`;
                    chartConfig.options.plugins.title.font.size = 14;
                    new Chart(canvas, chartConfig);
                });
            } else {
                if (mainChart) {
                    mainChart.destroy();
                }
                const data = datasets[state.dataset].data;
                const chartConfig = getChartConfig(data);
                mainChart = new Chart(document.getElementById('mainChart'), chartConfig);
            }
        }

        function getChartConfig(data) {
            let chartType, chartData, chartOptions;
            const themeColors = themes[state.theme];
            
            const baseOptions = {
                responsive: true,
                maintainAspectRatio: false,
                scales: {
                    x: { 
                        title: { display: !!state.xlab, text: state.xlab, color: themeColors.text },
                        grid: { color: themeColors.grid },
                        ticks: { color: themeColors.ticks }
                    },
                    y: { 
                        title: { display: !!state.ylab, text: state.ylab, color: themeColors.text },
                        grid: { color: themeColors.grid },
                        ticks: { color: themeColors.ticks }
                    }
                },
                plugins: {
                    title: { display: !!state.title, text: state.title, font: { size: 18 }, color: themeColors.text, padding: { bottom: 20 } },
                    legend: { display: state.color !== 'None', labels: { color: themeColors.text } }
                },
                animation: { duration: 500 },
                 layout: {
                    padding: 10
                }
            };

            switch (state.geom) {
                case 'geom_point':
                    chartType = 'scatter';
                    chartData = buildScatterData(data);
                    chartOptions = baseOptions;
                    break;
                case 'geom_bar':
                    chartType = 'bar';
                    chartData = buildBarData(data);
                    chartOptions = baseOptions;
                    break;
                case 'geom_histogram':
                    chartType = 'bar';
                    chartData = buildHistogramData(data);
                    chartOptions = baseOptions;
                    chartOptions.scales.x.type = 'linear';
                    break;
                case 'geom_boxplot':
                    chartType = 'boxplot';
                    chartData = buildBoxPlotData(data);
                    chartOptions = baseOptions;
                    break;
            }
            
            chartOptions.plugins.tooltip = {
                backgroundColor: 'rgba(0,0,0,0.7)',
                titleFont: { size: 14 },
                bodyFont: { size: 12 },
                padding: 10,
                callbacks: {
                    label: function(context) {
                        if (chartType === 'scatter') {
                            return `(${context.raw.x.toFixed(2)}, ${context.raw.y.toFixed(2)})`;
                        }
                        if (chartType === 'boxplot') {
                             const stats = context.raw;
                             return [
                                `Max: ${stats.max}`,
                                `Q3: ${stats.q3}`,
                                `Median: ${stats.median}`,
                                `Q1: ${stats.q1}`,
                                `Min: ${stats.min}`
                             ];
                        }
                        return `${context.dataset.label}: ${context.raw.y || context.raw}`;
                    }
                }
            };
            
            return { type: chartType, data: chartData, options: chartOptions };
        }

        // --- DATA BUILDERS ---
        function buildScatterData(data) {
            const colorVar = state.color;
            const xVar = state.x;
            const yVar = state.y;
            
            if (colorVar === 'None') {
                return {
                    datasets: [{
                        label: `${xVar} vs ${yVar}`,
                        data: data.map(d => ({ x: d[xVar], y: d[yVar] })).filter(d => d.x != null && d.y != null),
                        backgroundColor: 'rgba(54, 162, 235, 0.6)'
                    }]
                };
            }

            const groups = groupBy(data.filter(d => d[colorVar] != null && d[xVar] != null && d[yVar] != null), colorVar);
            const colors = generateColors(Object.keys(groups).length);
            return {
                datasets: Object.keys(groups).map((groupName, i) => ({
                    label: groupName,
                    data: groups[groupName].map(d => ({ x: d[xVar], y: d[yVar] })),
                    backgroundColor: colors[i]
                }))
            };
        }

        function buildBarData(data) {
            const xVar = state.x;
            const colorVar = state.color;
            const counts = {};

            data.forEach(d => {
                const xVal = d[xVar];
                if (xVal == null) return;
                
                const colorVal = colorVar === 'None' ? 'All' : d[colorVar];
                if (colorVal == null) return;

                if (!counts[xVal]) counts[xVal] = {};
                if (!counts[xVal][colorVal]) counts[xVal][colorVal] = 0;
                counts[xVal][colorVal]++;
            });

            const labels = Object.keys(counts).sort();
            const colorGroups = [...new Set(Object.values(counts).flatMap(Object.keys))].sort();
            const colors = generateColors(colorGroups.length);

            return {
                labels,
                datasets: colorGroups.map((c, i) => ({
                    label: c,
                    data: labels.map(label => counts[label]?.[c] || 0),
                    backgroundColor: colors[i]
                }))
            };
        }

        function buildHistogramData(data) {
            const xVar = state.x;
            const values = data.map(d => d[xVar]).filter(v => v != null).sort((a, b) => a - b);
            const min = values[0];
            const max = values[values.length - 1];
            const binCount = 20;
            const binWidth = (max - min) / binCount;

            const bins = Array(binCount).fill(0);
            const labels = [];
            for (let i = 0; i < binCount; i++) {
                labels.push((min + i * binWidth).toFixed(1));
            }

            values.forEach(v => {
                const binIndex = Math.min(Math.floor((v - min) / binWidth), binCount - 1);
                bins[binIndex]++;
            });

            return {
                labels,
                datasets: [{
                    label: `Frequency of ${xVar}`,
                    data: bins,
                    backgroundColor: 'rgba(75, 192, 192, 0.6)',
                    barPercentage: 1,
                    categoryPercentage: 1
                }]
            };
        }

        function buildBoxPlotData(data) {
            const xVar = state.x;
            const yVar = state.y;
            const groups = groupBy(data.filter(d => d[xVar] != null && d[yVar] != null), xVar);
            const labels = Object.keys(groups).sort();
            
            const boxplotData = labels.map(label => {
                const values = groups[label].map(d => d[yVar]).sort((a,b) => a - b);
                return {
                    min: values[0],
                    q1: quantile(values, 0.25),
                    median: quantile(values, 0.5),
                    q3: quantile(values, 0.75),
                    max: values[values.length - 1],
                    outliers: [] // Simplified for this example
                };
            });

            return {
                labels,
                datasets: [{
                    label: `Distribution of ${yVar}`,
                    data: boxplotData,
                    backgroundColor: 'rgba(255, 99, 132, 0.6)',
                    borderColor: 'rgb(255, 99, 132)',
                    borderWidth: 1,
                    padding: 10,
                    itemRadius: 0
                }]
            };
        }
        
        function downloadPlot() {
            const canvasToDownload = state.facet !== 'None' ? facetGrid : mainChart.canvas;
            if (state.facet !== 'None') {
                // Create a temporary canvas to merge faceted plots
                const canvases = Array.from(facetGrid.querySelectorAll('canvas'));
                if (canvases.length === 0) return;
                
                const cols = 2;
                const rows = Math.ceil(canvases.length / cols);
                const firstCanvas = canvases[0];
                const tempCanvas = document.createElement('canvas');
                tempCanvas.width = firstCanvas.width * cols;
                tempCanvas.height = firstCanvas.height * rows;
                const ctx = tempCanvas.getContext('2d');
                ctx.fillStyle = themes[state.theme].bg;
                ctx.fillRect(0, 0, tempCanvas.width, tempCanvas.height);
                
                canvases.forEach((canvas, i) => {
                    const row = Math.floor(i / cols);
                    const col = i % cols;
                    ctx.drawImage(canvas, col * firstCanvas.width, row * firstCanvas.height);
                });
                
                const link = document.createElement('a');
                link.download = 'ggplot_interactive_plot.png';
                link.href = tempCanvas.toDataURL('image/png');
                link.click();

            } else {
                 const link = document.createElement('a');
                 link.download = 'ggplot_interactive_plot.png';
                 link.href = mainChart.canvas.toDataURL('image/png');
                 link.click();
            }
        }


        // --- HELPERS ---
        function groupBy(arr, key) {
            return arr.reduce((acc, item) => {
                (acc[item[key]] = acc[item[key]] || []).push(item);
                return acc;
            }, {});
        }
        
        function quantile(arr, q) {
            const pos = (arr.length - 1) * q;
            const base = Math.floor(pos);
            const rest = pos - base;
            if (arr[base + 1] !== undefined) {
                return arr[base] + rest * (arr[base + 1] - arr[base]);
            } else {
                return arr[base];
            }
        }

        function generateColors(count) {
            const colors = [
                'rgba(255, 99, 132, 0.7)', 'rgba(54, 162, 235, 0.7)', 'rgba(255, 206, 86, 0.7)',
                'rgba(75, 192, 192, 0.7)', 'rgba(153, 102, 255, 0.7)', 'rgba(255, 159, 64, 0.7)'
            ];
            let result = [];
            for (let i = 0; i < count; i++) {
                result.push(colors[i % colors.length]);
            }
            return result;
        }

        // --- START ---
        init();
        document.querySelector('.accordion-button').click();
    });
</script>
</body>
</html>
